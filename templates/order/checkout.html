{% extends "base.html" %}

{% block title %}Checkout - Restaurant Site{% endblock %}

{% block content %}
<div id="checkout-app"></div>

<script type="text/babel">
    function CheckoutApp() {
        const [cart, setCart] = React.useState(null);
        const [formData, setFormData] = React.useState({
            customer_name: '',
            customer_phone: '',
            customer_email: '',
            delivery_address: '',
            payment_method: 'bank_transfer',
            payment_notes: ''
        });
        const [receipt, setReceipt] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [submitting, setSubmitting] = React.useState(false);
        const [errors, setErrors] = React.useState({});

        React.useEffect(() => {
            fetchCart();
        }, []);

        const fetchCart = async () => {
            try {
                const response = await fetch('/cart/api/items/');
                const data = await response.json();
                setCart(data);
                setLoading(false);
            } catch (error) {
                console.error('Error fetching cart:', error);
                setLoading(false);
            }
        };

        const handleChange = (e) => {
            setFormData({
                ...formData,
                [e.target.name]: e.target.value
            });
        };

        const handleFileChange = (e) => {
            setReceipt(e.target.files[0]);
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            setSubmitting(true);
            setErrors({});

            const submitData = new FormData();
            Object.keys(formData).forEach(key => {
                submitData.append(key, formData[key]);
            });
            if (receipt) {
                submitData.append('receipt', receipt);
            }

            try {
                const response = await fetch('/order/api/checkout/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': window.csrfToken
                    },
                    body: submitData
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Order placed successfully!');
                    window.location.href = `/order/tracking/${data.id}/`;
                } else {
                    setErrors(data);
                }
            } catch (error) {
                setErrors({ general: 'Network error. Please try again.' });
            } finally {
                setSubmitting(false);
            }
        };

        if (loading) {
            return (
                <div className="flex justify-center items-center h-64">
                    <div className="text-xl text-gray-600">Loading checkout...</div>
                </div>
            );
        }

        if (!cart || cart.items.length === 0) {
            return (
                <div className="text-center py-12">
                    <h1 className="text-3xl font-bold text-gray-900 mb-4">Your Cart is Empty</h1>
                    <a href="/menu/" className="bg-primary text-white px-6 py-3 rounded-lg">
                        Browse Menu
                    </a>
                </div>
            );
        }

        return (
            <div className="max-w-4xl mx-auto">
                <h1 className="text-3xl font-bold text-gray-900 mb-8">Checkout</h1>
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    {/* Order Summary */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-semibold mb-4">Order Summary</h2>
                        {cart.items.map(item => (
                            <div key={item.id} className="flex justify-between items-center py-2 border-b">
                                <div>
                                    <span className="font-medium">{item.food.name}</span>
                                    <span className="text-gray-600 ml-2">x{item.quantity}</span>
                                </div>
                                <span className="font-semibold">${item.subtotal}</span>
                            </div>
                        ))}
                        <div className="flex justify-between items-center pt-4 text-xl font-bold">
                            <span>Total:</span>
                            <span>${cart.total_price}</span>
                        </div>
                    </div>

                    {/* Checkout Form */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h2 className="text-xl font-semibold mb-4">Customer Information</h2>
                        
                        {errors.general && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {errors.general}
                            </div>
                        )}

                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    Full Name *
                                </label>
                                <input
                                    type="text"
                                    name="customer_name"
                                    value={formData.customer_name}
                                    onChange={handleChange}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary"
                                    required
                                />
                                {errors.customer_name && <p className="text-red-500 text-xs mt-1">{errors.customer_name[0]}</p>}
                            </div>

                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    Phone Number *
                                </label>
                                <input
                                    type="tel"
                                    name="customer_phone"
                                    value={formData.customer_phone}
                                    onChange={handleChange}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary"
                                    required
                                />
                                {errors.customer_phone && <p className="text-red-500 text-xs mt-1">{errors.customer_phone[0]}</p>}
                            </div>

                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    Email *
                                </label>
                                <input
                                    type="email"
                                    name="customer_email"
                                    value={formData.customer_email}
                                    onChange={handleChange}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary"
                                    required
                                />
                                {errors.customer_email && <p className="text-red-500 text-xs mt-1">{errors.customer_email[0]}</p>}
                            </div>

                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    Delivery Address
                                </label>
                                <textarea
                                    name="delivery_address"
                                    value={formData.delivery_address}
                                    onChange={handleChange}
                                    rows="3"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary"
                                    placeholder="Enter your delivery address (optional for pickup)"
                                />
                            </div>

                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    Payment Method *
                                </label>
                                <select
                                    name="payment_method"
                                    value={formData.payment_method}
                                    onChange={handleChange}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary"
                                    required
                                >
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="cash_on_delivery">Cash on Delivery</option>
                                    <option value="mobile_payment">Mobile Payment</option>
                                </select>
                            </div>

                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    Upload Payment Receipt
                                </label>
                                <input
                                    type="file"
                                    accept="image/*"
                                    onChange={handleFileChange}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary"
                                />
                                <p className="text-gray-500 text-xs mt-1">
                                    Upload receipt for bank transfer or mobile payment
                                </p>
                            </div>

                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2">
                                    Payment Notes
                                </label>
                                <textarea
                                    name="payment_notes"
                                    value={formData.payment_notes}
                                    onChange={handleChange}
                                    rows="2"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-primary"
                                    placeholder="Any additional payment information"
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={submitting}
                                className="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors disabled:opacity-50"
                            >
                                {submitting ? 'Placing Order...' : 'Place Order'}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        );
    }

    ReactDOM.render(<CheckoutApp />, document.getElementById('checkout-app'));
</script>
{% endblock %}
