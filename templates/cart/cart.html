{% extends "base.html" %}

{% block title %}Shopping Cart - Restaurant Site{% endblock %}

{% block content %}
<div id="cart-app"></div>

<script type="text/babel">
    function CartApp() {
        const [cart, setCart] = React.useState(null);
        const [loading, setLoading] = React.useState(true);

        React.useEffect(() => {
            fetchCart();
        }, []);

        const fetchCart = async () => {
            try {
                const response = await fetch('/cart/api/items/');
                const data = await response.json();
                setCart(data);
                setLoading(false);
            } catch (error) {
                console.error('Error fetching cart:', error);
                setLoading(false);
            }
        };

        const updateQuantity = async (itemId, quantity) => {
            try {
                const response = await fetch(`/cart/api/update/${itemId}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrfToken
                    },
                    body: JSON.stringify({ quantity })
                });
                
                if (response.ok) {
                    fetchCart();
                }
            } catch (error) {
                console.error('Error updating quantity:', error);
            }
        };

        const removeItem = async (itemId) => {
            try {
                const response = await fetch(`/cart/api/remove/${itemId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': window.csrfToken
                    }
                });
                
                if (response.ok) {
                    fetchCart();
                }
            } catch (error) {
                console.error('Error removing item:', error);
            }
        };

        if (loading) {
            return (
                <div className="flex justify-center items-center h-64">
                    <div className="text-xl text-gray-600">Loading cart...</div>
                </div>
            );
        }

        if (!cart || cart.items.length === 0) {
            return (
                <div className="text-center py-12">
                    <h1 className="text-3xl font-bold text-gray-900 mb-4">Your Cart is Empty</h1>
                    <p className="text-gray-600 mb-8">Add some delicious items from our menu!</p>
                    <a href="/menu/" className="bg-primary text-white px-6 py-3 rounded-lg text-lg hover:bg-orange-600 transition-colors">
                        Browse Menu
                    </a>
                </div>
            );
        }

        return (
            <div>
                <h1 className="text-3xl font-bold text-gray-900 mb-8">Shopping Cart</h1>
                
                <div className="bg-white rounded-lg shadow-md">
                    {cart.items.map(item => (
                        <div key={item.id} className="flex items-center p-6 border-b border-gray-200 last:border-b-0">
                            {item.food.image && (
                                <img 
                                    src={item.food.image || "/placeholder.svg"} 
                                    alt={item.food.name}
                                    className="w-20 h-20 object-cover rounded-lg mr-4"
                                />
                            )}
                            <div className="flex-1">
                                <h3 className="text-lg font-semibold text-gray-900">{item.food.name}</h3>
                                <p className="text-gray-600">${item.food.price} each</p>
                            </div>
                            <div className="flex items-center space-x-3">
                                <button
                                    onClick={() => updateQuantity(item.id, item.quantity - 1)}
                                    className="bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300"
                                >
                                    -
                                </button>
                                <span className="text-lg font-semibold w-8 text-center">{item.quantity}</span>
                                <button
                                    onClick={() => updateQuantity(item.id, item.quantity + 1)}
                                    className="bg-gray-200 text-gray-700 w-8 h-8 rounded-full hover:bg-gray-300"
                                >
                                    +
                                </button>
                            </div>
                            <div className="ml-6 text-right">
                                <div className="text-lg font-semibold text-gray-900">${item.subtotal}</div>
                                <button
                                    onClick={() => removeItem(item.id)}
                                    className="text-red-600 hover:text-red-800 text-sm"
                                >
                                    Remove
                                </button>
                            </div>
                        </div>
                    ))}
                </div>

                <div className="mt-8 bg-white rounded-lg shadow-md p-6">
                    <div className="flex justify-between items-center text-xl font-bold mb-4">
                        <span>Total: ${cart.total_price}</span>
                        <span>Items: {cart.total_items}</span>
                    </div>
                    <div className="flex space-x-4">
                        <a href="/menu/" className="flex-1 bg-gray-200 text-gray-800 py-3 px-6 rounded-lg text-center hover:bg-gray-300 transition-colors">
                            Continue Shopping
                        </a>
                        <a href="/order/checkout/" className="flex-1 bg-primary text-white py-3 px-6 rounded-lg text-center hover:bg-orange-600 transition-colors">
                            Proceed to Checkout
                        </a>
                    </div>
                </div>
            </div>
        );
    }

    ReactDOM.render(<CartApp />, document.getElementById('cart-app'));
</script>
{% endblock %}
