{% extends 'base.html' %}

{% block title %}Make a Reservation{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 py-12">
    <div class="container mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Reserve Your Table</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">Experience exceptional dining with us. Book your table for an unforgettable culinary journey.</p>
        </div>

        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="md:flex">
                    <!-- Image Section -->
                    <div class="md:w-1/2">
                        <img src="https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80" 
                             alt="Restaurant Interior" 
                             class="w-full h-64 md:h-full object-cover">
                    </div>
                    
                    <!-- Form Section -->
                    <div class="md:w-1/2 p-8">
                        <div id="reservation-form-container">
                            <!-- React component will render here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/babel">
    const { useState, useEffect } = React;

    function ReservationForm() {
        const [formData, setFormData] = useState({
            name: '',
            email: '',
            phone: '',
            date: '',
            time: '',
            party_size: 2,
            special_requests: ''
        });
        const [availableTimes, setAvailableTimes] = useState([]);
        const [loading, setLoading] = useState(false);
        const [message, setMessage] = useState('');
        const [errors, setErrors] = useState({});

        // Get tomorrow's date as minimum date
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const minDate = tomorrow.toISOString().split('T')[0];

        const fetchAvailableTimes = async (date) => {
            if (!date) return;
            
            try {
                const response = await fetch(`/reservation/api/available-times/?date=${date}`);
                const data = await response.json();
                setAvailableTimes(data.available_times || []);
                
                // Reset time if current selection is not available
                if (formData.time && !data.available_times.includes(formData.time)) {
                    setFormData(prev => ({ ...prev, time: '' }));
                }
            } catch (error) {
                console.error('Error fetching available times:', error);
            }
        };

        useEffect(() => {
            if (formData.date) {
                fetchAvailableTimes(formData.date);
            }
        }, [formData.date]);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            setMessage('');
            setErrors({});

            try {
                const response = await apiRequest('/reservation/api/create/', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response.success) {
                    setMessage('Reservation created successfully! We will confirm your booking shortly.');
                    setFormData({
                        name: '',
                        email: '',
                        phone: '',
                        date: '',
                        time: '',
                        party_size: 2,
                        special_requests: ''
                    });
                } else {
                    setErrors(response.errors || {});
                }
            } catch (error) {
                console.error('Reservation error:', error);
                setMessage('An error occurred. Please try again.');
            } finally {
                setLoading(false);
            }
        };

        const handleChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({ ...prev, [name]: value }));
        };

        const timeSlots = [
            { value: '11:00', label: '11:00 AM' },
            { value: '11:30', label: '11:30 AM' },
            { value: '12:00', label: '12:00 PM' },
            { value: '12:30', label: '12:30 PM' },
            { value: '13:00', label: '1:00 PM' },
            { value: '13:30', label: '1:30 PM' },
            { value: '14:00', label: '2:00 PM' },
            { value: '14:30', label: '2:30 PM' },
            { value: '17:00', label: '5:00 PM' },
            { value: '17:30', label: '5:30 PM' },
            { value: '18:00', label: '6:00 PM' },
            { value: '18:30', label: '6:30 PM' },
            { value: '19:00', label: '7:00 PM' },
            { value: '19:30', label: '7:30 PM' },
            { value: '20:00', label: '8:00 PM' },
            { value: '20:30', label: '8:30 PM' },
            { value: '21:00', label: '9:00 PM' },
            { value: '21:30', label: '9:30 PM' },
        ];

        return (
            <div>
                <h2 className="text-2xl font-bold text-gray-900 mb-6">Book Your Table</h2>
                
                {message && (
                    <div className={`p-4 rounded-lg mb-6 ${message.includes('success') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                        {message}
                    </div>
                )}

                <form onSubmit={handleSubmit} className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                            <input
                                type="text"
                                name="name"
                                value={formData.name}
                                onChange={handleChange}
                                required
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                placeholder="Your full name"
                            />
                            {errors.name && <p className="text-red-500 text-sm mt-1">{errors.name[0]}</p>}
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                            <input
                                type="email"
                                name="email"
                                value={formData.email}
                                onChange={handleChange}
                                required
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                placeholder="your@email.com"
                            />
                            {errors.email && <p className="text-red-500 text-sm mt-1">{errors.email[0]}</p>}
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Phone *</label>
                        <input
                            type="tel"
                            name="phone"
                            value={formData.phone}
                            onChange={handleChange}
                            required
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                            placeholder="+1 (555) 123-4567"
                        />
                        {errors.phone && <p className="text-red-500 text-sm mt-1">{errors.phone[0]}</p>}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                            <input
                                type="date"
                                name="date"
                                value={formData.date}
                                onChange={handleChange}
                                min={minDate}
                                required
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                            />
                            {errors.date && <p className="text-red-500 text-sm mt-1">{errors.date[0]}</p>}
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Time *</label>
                            <select
                                name="time"
                                value={formData.time}
                                onChange={handleChange}
                                required
                                disabled={!formData.date}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent disabled:bg-gray-100"
                            >
                                <option value="">Select time</option>
                                {timeSlots.map(slot => (
                                    <option 
                                        key={slot.value} 
                                        value={slot.value}
                                        disabled={!availableTimes.includes(slot.value)}
                                    >
                                        {slot.label} {!availableTimes.includes(slot.value) && formData.date ? '(Booked)' : ''}
                                    </option>
                                ))}
                            </select>
                            {errors.time && <p className="text-red-500 text-sm mt-1">{errors.time[0]}</p>}
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Party Size *</label>
                            <select
                                name="party_size"
                                value={formData.party_size}
                                onChange={handleChange}
                                required
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                            >
                                {[...Array(20)].map((_, i) => (
                                    <option key={i + 1} value={i + 1}>
                                        {i + 1} {i === 0 ? 'person' : 'people'}
                                    </option>
                                ))}
                            </select>
                            {errors.party_size && <p className="text-red-500 text-sm mt-1">{errors.party_size[0]}</p>}
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Special Requests</label>
                        <textarea
                            name="special_requests"
                            value={formData.special_requests}
                            onChange={handleChange}
                            rows="3"
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                            placeholder="Any dietary restrictions, special occasions, or other requests..."
                        ></textarea>
                    </div>

                    <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-amber-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-amber-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {loading ? 'Booking...' : 'Reserve Table'}
                    </button>
                </form>
            </div>
        );
    }

    ReactDOM.render(<ReservationForm />, document.getElementById('reservation-form-container'));
</script>
{% endblock %}
